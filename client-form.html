<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulaire d'Information Client - Alimentation Première</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .bg-image-overlay {
            background-image: linear-gradient(rgba(0, 0, 0, 0.85), rgba(0, 0, 0, 0.85)), url('https://www.alimentationpremiere.ca/wp-content/uploads/2025/01/cropped-Logo-AP-Rougeombre.png');
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
        }

        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
    </style>
</head>
<body class="bg-black">
    <div class="bg-image-overlay min-h-screen">
        <!-- User Info Bar -->
        <div class="bg-black/50 backdrop-blur-sm shadow-sm">
            <div class="max-w-7xl mx-auto px-4 py-2 flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <span id="userName" class="font-medium text-white"></span>
                    <span id="userRole" class="text-sm text-gray-300"></span>
                </div>
                <button onclick="logout()" class="text-sm text-red-400 hover:text-red-300">
                    Se déconnecter
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="max-w-4xl mx-auto p-6">
            <form id="clientForm" class="space-y-6 glass-effect p-8 rounded-lg shadow-xl">
                <!-- Visit Information Section -->
                <div class="border-b border-red-800/10 pb-4 mb-4">
                    <h2 class="text-lg font-bold mb-4 text-gray-900 border-b border-red-800/20 pb-2">Information de la visite</h2>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-1">Date de la réception</label>
                            <input type="date" name="dateReception" class="w-full px-3 py-3 border rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-red-800 bg-white/90">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-1">Date de la présentation</label>
                            <input type="date" name="datePresentation" class="w-full px-3 py-3 border rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-red-800 bg-white/90">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-1">Heure de la présentation</label>
                            <select name="heurePresentation" class="w-full px-3 py-3 border rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-red-800 bg-white/90" required>
                                <option value="">Sélectionner une heure...</option>
                                <option value="09:00">09:00</option>
                                <option value="11:00">11:00</option>
                                <option value="13:00">13:00</option>
                                <option value="15:00">15:00</option>
                                <option value="17:00">17:00</option>
                                <option value="19:00">19:00</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-1">Distributeur</label>
                            <input type="text" name="distributeur" class="w-full px-3 py-3 border rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-red-800 bg-white/90">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-1">Superviseur</label>
                            <input type="text" name="superviseur" class="w-full px-3 py-3 border rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-red-800 bg-white/90">
                        </div>
                    </div>
                </div>				
                <div class="border-b border-red-800/10 pb-4 mb-4">
                    <h2 class="text-lg font-bold mb-4 text-gray-900 border-b border-red-800/20 pb-2">Information de suivi</h2>
                    <div class="space-y-3"> 
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-1">Numéro de commande</label>
                            <input type="text" name="orderNumber" 
                                class="w-full px-3 py-3 border rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-red-800 bg-white/90 cursor-not-allowed"
                                pattern="AP\d{5}"
                                title="Format: AP + DDMMR"
                                readonly
                                required>
                            <p class="text-sm text-gray-500 mt-1">Généré automatiquement</p>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-1">Région</label>
                            <select name="region" 
                                class="w-full px-3 py-3 border rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-red-800 bg-white/90"
                                required>
                                <option value="">Sélectionner une région...</option>
                                <option value="Sherbrooke">Sherbrooke</option>
                                <option value="Blainville">Blainville</option>
                                <option value="Beloeil">Beloeil</option>
                                <option value="Trois-Riviere">Trois-Rivière</option>
                                <option value="Quebec">Québec</option>
                                <option value="Gatineau">Gatineau</option>
                                <option value="Saguenay">Saguenay</option>
                                <option value="La_Prairie">La Prairie</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Client Information Section -->
                <div class="border-b border-red-800/10 pb-4 mb-4">
                    <h2 class="text-lg font-bold mb-4 text-gray-900 border-b border-red-800/20 pb-2">Information du client</h2>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-1">Nom Complet (1)</label>
                            <input type="text" name="nomComplet1" class="w-full px-3 py-3 border rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-red-800 bg-white/90">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-1">Nom Complet (2)</label>
                            <input type="text" name="nomComplet2" class="w-full px-3 py-3 border rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-red-800 bg-white/90">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-1">Adresse complète</label>
                            <input type="text" name="adresse" class="w-full px-3 py-3 border rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-red-800 bg-white/90">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-1">Courriel</label>
                            <input type="text" name="courriel" class="w-full px-3 py-3 border rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-red-800 bg-white/90">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-1">Ville</label>
                            <input type="text" name="ville" class="w-full px-3 py-3 border rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-red-800 bg-white/90">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-1">Code postal</label>
                            <input type="text" name="codePostal" class="w-full px-3 py-3 border rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-red-800 bg-white/90">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-1">Cellulaire (1)</label>
                            <input type="tel" name="cellulaire1" class="w-full px-3 py-3 border rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-red-800 bg-white/90">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-1">Cellulaire (2)</label>
                            <input type="tel" name="cellulaire2" class="w-full px-3 py-3 border rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-red-800 bg-white/90">
                        </div>
                    </div>
                </div>

                <!-- Additional Information Section -->
                <div class="border-b border-red-800/10 pb-4 mb-4">
                    <h2 class="text-lg font-bold mb-4 text-gray-900 border-b border-red-800/20 pb-2">Information additionnelle</h2>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-1">Emploie des clients</label>
                            <input type="text" name="emploi" class="w-full px-3 py-3 border rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-red-800 bg-white/90">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-1">Nombre de personne dans la maison</label>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-gray-700 text-sm">Adulte</label>
                                    <input type="number" name="nombreAdultes" min="0" class="w-full px-3 py-3 border rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-red-800 bg-white/90">
                                </div>
                                <div>
                                    <label class="block text-gray-700 text-sm">Enfant</label>
                                    <input type="number" name="nombreEnfants" min="0" class="w-full px-3 py-3 border rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-red-800 bg-white/90">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Food & Freezer Section -->
                <div class="border-b border-red-800/10 pb-4 mb-4">
                    <h2 class="text-lg font-bold mb-4 text-gray-900 border-b border-red-800/20 pb-2">Information sur l'alimentation</h2>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-1">Budget épicerie Global</label>
                            <input type="text" name="budgetEpicerie" class="w-full px-3 py-3 border rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-red-800 bg-white/90">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-1">Protéine par semaine</label>
                            <input type="text" name="proteineParSemaine" class="w-full px-3 py-3 border rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-red-800 bg-white/90">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-1">Congélateur autre que celui du frigo</label>
                            <select name="congelateurAutre" class="w-full px-3 py-3 border rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-red-800 bg-white/90">
                                <option value="">Sélectionner...</option>
                                <option value="OUI">Oui</option>
                                <option value="NON">Non</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-1">Capacité du congélateur</label>
                            <select name="grandeurCongel" class="w-full px-3 py-3 border rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-red-800 bg-white/90">
                                <option value="">Sélectionner...</option>
                                <option value="VIDE">Vide</option>
                                <option value="MOITIÉ">Moitié</option>
                                <option value="PLEIN">Plein</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Notes Section -->
                <div class="mb-4">
                    <h2 class="text-lg font-bold mb-4 text-gray-900 border-b border-red-800/20 pb-2">Notes</h2>
                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-1">Note Importante</label>
                        <textarea name="noteImportante" rows="4" class="w-full px-3 py-3 border rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-red-800 bg-white/90"></textarea>
                    </div>
                    <div class="mt-4">
                        <label class="block text-gray-700 text-sm font-medium mb-1">Fournisseur</label>
                        <textarea name="fournisseur" rows="4" class="w-full px-3 py-3 border rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-red-800 bg-white/90"></textarea>
                    </div>
                </div>

                <!-- Submit Button -->
                <button type="submit" id="submitBtn" class="w-full bg-red-800 text-white py-3 px-4 rounded-lg text-lg font-medium hover:bg-red-900 focus:outline-none focus:ring-2 focus:ring-red-700">
                    Envoyer
                </button>
            </form>
            
            <!-- Preview Modal -->
            <div id="previewModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm overflow-y-auto h-full w-full z-50">
                <div class="relative top-20 mx-auto p-5 border w-full max-w-4xl shadow-lg rounded-md glass-effect">
                    <div class="flex flex-col h-full">
                        <!-- Modal Header -->
                        <div class="flex justify-between items-center pb-3 border-b border-red-800/20">
                            <p class="text-2xl font-bold text-gray-900">Aperçu des informations</p>
                            <button id="closeModal" class="text-gray-400 hover:text-red-800">
                                <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                </svg>
                            </button>
                        </div>

                        <!-- Preview Content -->
                        <div class="mt-4 bg-white rounded-lg p-4 text-gray-800 overflow-y-auto max-h-[60vh] min-h-[200px] shadow-xl">
                            <div id="previewContent" class="space-y-4">
                                <!-- Preview content will be inserted here -->
                            </div>
                        </div>

                        <!-- Modal Footer -->
                        <div class="flex justify-end gap-4 mt-4 relative z-10">
                            <button id="modifyBtn" class="px-4 py-2 bg-gray-100 text-gray-800 rounded-lg hover:bg-gray-200 shadow-sm">
                                Modifier
                            </button>
                            <button id="confirmSendBtn" class="px-4 py-2 bg-red-800 text-white rounded-lg hover:bg-red-900 shadow-sm">
                                Confirmer l'envoi
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration for HubSpot integration
        const HUBSPOT_PORTAL_ID = "46950315"; // Replace with your HubSpot Portal ID
        const HUBSPOT_FORM_ID = "d5ef42ee-e6b6-4285-b438-0ae4fcf93056"; // Replace with your HubSpot Form ID

        function checkAuth() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (!currentUser) {
                window.location.href = 'index.html';
                return;
            }

            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userRole').textContent = 
                currentUser.role === 'supervisor' ? 'Superviseur' : 'Portier';
        }

        function logout() {
            localStorage.removeItem('currentUser');
            window.location.href = 'index.html';
        }

        function formatPhoneNumber(phoneNumber) {
            // Remove all non-numeric characters
            const cleaned = phoneNumber.replace(/\\D/g, '');
            
            // Check if we have a 10-digit number
            if(cleaned.length === 10) {
                return cleaned.replace(/(\\d{3})(\\d{3})(\\d{4})/, '$1-$2-$3');
            }
            
            // If not 10 digits, return original input
            return phoneNumber;
        }

        function generateOrderNumber() {
            const date = new Date();
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            
            // Generate a random single digit (0-9)
            const random = Math.floor(Math.random() * 10).toString();
            
            // Combine everything into the order number
            // Format: AP + DD + MM + R
            return `AP${day}${month}${random}`;
        }

        function createPreviewContent(formData) {
            const sections = [
                {
                    title: "Information de suivi",
                    fields: [
                        { label: "Numéro de commande", value: formData.get('orderNumber') || 'Non spécifié' },
                        { label: "Région", value: formData.get('region') || 'Non spécifiée' }
                    ]
                },
                {
                    title: "Information de la visite",
                    fields: [
                        { label: "Date de réception", value: formData.get('dateReception') || 'Non spécifiée' },
                        { label: "Date de présentation", value: formData.get('datePresentation') || 'Non spécifiée' },
                        { label: "Heure de présentation", value: formData.get('heurePresentation') || 'Non spécifiée' },
                        { label: "Distributeur", value: formData.get('distributeur') || 'Non spécifié' },
                        { label: "Superviseur", value: formData.get('superviseur') || 'Non spécifié' }
                    ]
                },
                {
                    title: "Information du client",
                    fields: [
                        { label: "Nom (1)", value: formData.get('nomComplet1') || 'Non spécifié' },
                        { label: "Nom (2)", value: formData.get('nomComplet2') || 'Non spécifié' },
                        { label: "Adresse", value: formData.get('adresse') || 'Non spécifiée' },
                        { label: "Courriel", value: formData.get('courriel') || 'Non spécifié' },
                        { label: "Ville", value: formData.get('ville') || 'Non spécifiée' },
                        { label: "Code postal", value: formData.get('codePostal') || 'Non spécifié' },
                        { label: "Cellulaire (1)", value: formatPhoneNumber(formData.get('cellulaire1') || '') },
                        { label: "Cellulaire (2)", value: formatPhoneNumber(formData.get('cellulaire2') || '') }
                    ]
                },
                {
                    title: "Information additionnelle",
                    fields: [
                        { label: "Emploi", value: formData.get('emploi') || 'Non spécifié' },
                        { label: "Adultes", value: formData.get('nombreAdultes') || '0' },
                        { label: "Enfants", value: formData.get('nombreEnfants') || '0' }
                    ]
                },
                {
                    title: "Information sur l'alimentation",
                    fields: [
                        { label: "Budget épicerie", value: formData.get('budgetEpicerie') || 'Non spécifié' },
                        { label: "Protéine/semaine", value: formData.get('proteineParSemaine') || 'Non spécifié' },
                        { label: "Autre congélateur", value: formData.get('congelateurAutre') || 'Non spécifié' },
                        { label: "État congélateur", value: formData.get('grandeurCongel') || 'Non spécifié' }
                    ]
                },
                {
                    title: "Notes",
                    fields: [
                        { label: "Note importante", value: formData.get('noteImportante') || 'Aucune' },
                        { label: "Fournisseur", value: formData.get('fournisseur') || 'Aucun' }
                    ]
                }
            ];

            return sections;
        }

           function showPreview(formData) {
           // S'assurer que le numéro de commande est à jour
           const orderNumberInput = document.querySelector('input[name="orderNumber"]');
           if (orderNumberInput) {
               // Mettre à jour formData avec la valeur actuelle du numéro de commande
               formData.set('orderNumber', orderNumberInput.value);
           }
    
            const modal = document.getElementById('previewModal');
            const previewContent = document.getElementById('previewContent');
            
            // Clear previous content
            previewContent.innerHTML = '';
            
            // Create preview content
            const sections = createPreviewContent(formData);
            
            sections.forEach(section => {
                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'mb-6';
                
                // Section title
                const titleDiv = document.createElement('div');
                titleDiv.className = 'text-lg font-semibold mb-2 text-red-800 border-b border-red-800/20 pb-1';
                titleDiv.textContent = section.title;
                sectionDiv.appendChild(titleDiv);
                
                // Section fields
                const fieldsDiv = document.createElement('div');
                fieldsDiv.className = 'grid grid-cols-1 md:grid-cols-2 gap-2';
                
                section.fields.forEach(field => {
                    const fieldDiv = document.createElement('div');
                    fieldDiv.className = 'mb-1';
                    
                    const labelSpan = document.createElement('span');
                    labelSpan.className = 'font-medium text-gray-700';
                    labelSpan.textContent = `${field.label}: `;
                    fieldDiv.appendChild(labelSpan);
                    
                    const valueSpan = document.createElement('span');
                    valueSpan.className = 'text-gray-900';
                    valueSpan.textContent = field.value;
                    fieldDiv.appendChild(valueSpan);
                    
                    fieldsDiv.appendChild(fieldDiv);
                });
                
                sectionDiv.appendChild(fieldsDiv);
                previewContent.appendChild(sectionDiv);
            });
            
            modal.classList.remove('hidden');
        }

        // Submit to HubSpot
        async function submitToHubSpot(formData) {
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Envoi en cours...';

            try {
                // Prepare the data for HubSpot
                const hubspotData = {
                    portalId: HUBSPOT_PORTAL_ID,
                    formId: HUBSPOT_FORM_ID,
                    fields: [
                        // Information de suivi
                        { name: "numero_de_commande", value: formData.get('orderNumber') },
                        { name: "region", value: formData.get('region') },
                        
                        // Information de la visite
                        { name: "date_de_reception", value: formData.get('dateReception') },
                        { name: "date_de_la_presentation", value: formData.get('datePresentation') },
                        { name: "heure_de_presentation", value: formData.get('heurePresentation') },
                        { name: "distributeur", value: formData.get('distributeur') },
                        { name: "superviseur", value: formData.get('superviseur') },
                        
                        // Information du client
                        { name: "firstname", value: formData.get('nomComplet1').split(' ')[0] },
                        { name: "lastname", value: formData.get('nomComplet1').split(' ').slice(1).join(' ') },
                        { name: "conjoint_e_", value: formData.get('nomComplet2') },
                        { name: "adresse", value: formData.get('adresse') },
                        { name: "email", value: formData.get('courriel') },
                        { name: "city", value: formData.get('ville'), objectTypeId: "0-1" },
                        { name: "zip", value: formData.get('codePostal') },
                        { name: "phone", value: formData.get('cellulaire1') },
                        { name: "cell_conjoint_e_", value: formData.get('cellulaire2') },
                        
                        // Information additionnelle
                        { name: "emploi_du_client", value: formData.get('emploi') },
                        { name: "nombre_d_adultes", value: formData.get('nombreAdultes') },
                        { name: "nombre_d_enfants", value: formData.get('nombreEnfants') },
                        
                        // Information sur l'alimentation
                        { name: "budget_epicerie_global", value: formData.get('budgetEpicerie') },
                        { name: "proteine_par_semaine", value: formData.get('proteineParSemaine') },
                        { name: "congelateur_present", value: formData.get('congelateurAutre') },
                        { name: "capacite_de_congelateur", value: formData.get('grandeurCongel') },
                        
                        // Notes
                        { name: "note_importante", value: formData.get('noteImportante') },
                        { name: "fournisseur", value: formData.get('fournisseur') }
                    ]
                };

        console.log("Envoi des données à HubSpot...");
        
        // Envoi réel à l'API HubSpot
        const response = await fetch(`https://api.hsforms.com/submissions/v3/integration/submit/${HUBSPOT_PORTAL_ID}/${HUBSPOT_FORM_ID}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(hubspotData)
        });

        if (!response.ok) {
            const errorText = await response.text();
            console.error("Réponse d'erreur HubSpot:", errorText);
            throw new Error(`HubSpot API error: ${response.status}`);
        }
        
        const result = await response.json();
        console.log("Succès de l'envoi à HubSpot:", result);
        
        alert('Information envoyée avec succès!');
        document.getElementById('clientForm').reset();
        
        // Generate a new order number for the next submission
        const orderNumberInput = document.querySelector('input[name="orderNumber"]');
        if (orderNumberInput) {
            orderNumberInput.value = generateOrderNumber();
        }
        
        return true;
    } catch (error) {
        console.error('Error submitting to HubSpot:', error);
        alert('Erreur lors de l\'envoi. Veuillez réessayer.');
        return false;
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Envoyer';
    }
}
        // Initialize event listeners
        function initializeEventListeners() {
            // Generate order number when page loads
            document.addEventListener('DOMContentLoaded', function() {
                const orderNumberInput = document.querySelector('input[name="orderNumber"]');
                if (orderNumberInput) {
                    orderNumberInput.value = generateOrderNumber();
                }
            });
            
            // Form submit handler
            document.getElementById('clientForm').addEventListener('submit', function(e) {
            e.preventDefault();
        
            // Regénérer le numéro de commande si vide
            const orderNumberInput = document.querySelector('input[name="orderNumber"]');
            if (orderNumberInput && !orderNumberInput.value) {
                orderNumberInput.value = generateOrderNumber();
            }
        
            const formData = new FormData(this);
            showPreview(formData);
            });

            // Modal close button handler
            document.getElementById('closeModal').addEventListener('click', function() {
                document.getElementById('previewModal').classList.add('hidden');
            });

            // Modify button handler
            document.getElementById('modifyBtn').addEventListener('click', function() {
                document.getElementById('previewModal').classList.add('hidden');
            });

            // Confirm send button handler
            document.getElementById('confirmSendBtn').addEventListener('click', async function() {
                const form = document.getElementById('clientForm');
                const formData = new FormData(form);
                
                document.getElementById('previewModal').classList.add('hidden');
                const success = await submitToHubSpot(formData);
                
                if (success) {
                    form.reset();
                    const orderNumberInput = document.querySelector('input[name="orderNumber"]');
                    if (orderNumberInput) {
                        orderNumberInput.value = generateOrderNumber();
                    }
                }
            });
        }

        // Initialize when the page loads
        window.addEventListener('load', () => {
            checkAuth();
            initializeEventListeners();
        });
    </script>
</body>
</html>
