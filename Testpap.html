<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulaire d'Information Client - Alimentation Première</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .bg-image-overlay {
            background-image: linear-gradient(rgba(0, 0, 0, 0.85), rgba(0, 0, 0, 0.85)), url('https://www.alimentationpremiere.ca/wp-content/uploads/2025/01/cropped-Logo-AP-Rougeombre.png');
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
        }

        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
    </style>
</head>
<body class="bg-black">
    <div class="bg-image-overlay min-h-screen">
        <!-- User Info Bar -->
        <div class="bg-black/50 backdrop-blur-sm shadow-sm">
            <div class="max-w-7xl mx-auto px-4 py-2 flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <span id="userName" class="font-medium text-white"></span>
                    <span id="userRole" class="text-sm text-gray-300"></span>
                </div>
                <button onclick="logout()" class="text-sm text-red-400 hover:text-red-300">
                    Se déconnecter
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="max-w-4xl mx-auto p-6">
            <form id="clientForm" class="space-y-6 glass-effect p-8 rounded-lg shadow-xl">
                <!-- Visit Information Section -->
                <div class="border-b border-red-800/10 pb-4 mb-4">
                    <h2 class="text-lg font-bold mb-4 text-gray-900 border-b border-red-800/20 pb-2">Information de la visite</h2>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-1">Date de la réception</label>
                            <input type="date" name="dateReception" class="w-full px-3 py-3 border rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-red-800 bg-white/90">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-1">Date de la présentation</label>
                            <input type="date" name="datePresentation" class="w-full px-3 py-3 border rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-red-800 bg-white/90">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-1">Heure de la présentation</label>
                            <input type="time" name="heurePresentation" class="w-full px-3 py-3 border rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-red-800 bg-white/90">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-1">Distributeur</label>
                            <input type="text" name="distributeur" class="w-full px-3 py-3 border rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-red-800 bg-white/90">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-1">Superviseur</label>
                            <input type="text" name="superviseur" class="w-full px-3 py-3 border rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-red-800 bg-white/90">
                        </div>
                    </div>
                </div>				
                        <div class="border-b border-red-800/10 pb-4 mb-4">
                            <h2 class="text-lg font-bold mb-4 text-gray-900 border-b border-red-800/20 pb-2">Information de suivi</h2>
                            <div class="space-y-3"> 
			<div>
			    <label class="block text-gray-700 text-sm font-medium mb-1">Numéro de commande</label>
			    <input type="text" name="orderNumber" 
			        class="w-full px-3 py-3 border rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-red-800 bg-white/90 cursor-not-allowed"
			        pattern="AP\d{13}"
			        title="Format: AP + YYMMDDHHmmRRR"
			        readonly
			        required>
			    <p class="text-sm text-gray-500 mt-1">Généré automatiquement</p>
			</div>
       				  <div>
           			      <label class="block text-gray-700 text-sm font-medium mb-1">Région</label>
           			      <select name="region" 
                			   class="w-full px-3 py-3 border rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-red-800 bg-white/90"
                			   required>
                			   <option value="">Sélectionner une région...</option>
                			   <option value="sherbrooke">Sherbrooke</option>
                			   <option value="blainville">Blainville</option>
                		           <option value="saint-mathieu-de-beloeil">Saint-Mathieu-De-Beloeil</option>
                			   <option value="trois-riviere">Trois-Rivière</option>
                                           <option value="vaudreuil">Vaudreuil</option>
                                           <option value="quebec">Québec</option>
					   <option value="gatineau">Gatineau</option>
            				</select>
        			    </div>
   			        </div>
			    </div>

                <!-- Client Information Section -->
                <div class="border-b border-red-800/10 pb-4 mb-4">
                    <h2 class="text-lg font-bold mb-4 text-gray-900 border-b border-red-800/20 pb-2">Information du client</h2>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-1">Nom Complet (1)</label>
                            <input type="text" name="nomComplet1" class="w-full px-3 py-3 border rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-red-800 bg-white/90">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-1">Nom Complet (2)</label>
                            <input type="text" name="nomComplet2" class="w-full px-3 py-3 border rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-red-800 bg-white/90">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-1">Adresse complète</label>
                            <input type="text" name="adresse" class="w-full px-3 py-3 border rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-red-800 bg-white/90">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-1">Courriel</label>
                            <input type="text" name="courriel" class="w-full px-3 py-3 border rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-red-800 bg-white/90">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-1">Ville</label>
                            <input type="text" name="ville" class="w-full px-3 py-3 border rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-red-800 bg-white/90">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-1">Code postal</label>
                            <input type="text" name="codePostal" class="w-full px-3 py-3 border rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-red-800 bg-white/90">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-1">Cellulaire (1)</label>
                            <input type="tel" name="cellulaire1" class="w-full px-3 py-3 border rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-red-800 bg-white/90">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-1">Cellulaire (2)</label>
                            <input type="tel" name="cellulaire2" class="w-full px-3 py-3 border rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-red-800 bg-white/90">
                        </div>
                    </div>
                </div>

                <!-- Additional Information Section -->
                <div class="border-b border-red-800/10 pb-4 mb-4">
                    <h2 class="text-lg font-bold mb-4 text-gray-900 border-b border-red-800/20 pb-2">Information additionnelle</h2>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-1">Emploie des clients</label>
                            <input type="text" name="emploi" class="w-full px-3 py-3 border rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-red-800 bg-white/90">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-1">Statut</label>
                            <select name="statut" class="w-full px-3 py-3 border rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-red-800 bg-white/90">
                                <option value="">Sélectionner...</option>
                                <option value="proprietaire">Propriétaire</option>
                                <option value="locataire">Locataire</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-1">Nombre de personne dans la maison</label>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-gray-700 text-sm">Adulte</label>
                                    <input type="number" name="nombreAdultes" min="0" class="w-full px-3 py-3 border rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-red-800 bg-white/90">
                                </div>
                                <div>
                                    <label class="block text-gray-700 text-sm">Enfant</label>
                                    <input type="number" name="nombreEnfants" min="0" class="w-full px-3 py-3 border rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-red-800 bg-white/90">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Food & Freezer Section -->
                <div class="border-b border-red-800/10 pb-4 mb-4">
                    <h2 class="text-lg font-bold mb-4 text-gray-900 border-b border-red-800/20 pb-2">Information sur l'alimentation</h2>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-1">Budget épicerie Global</label>
                            <input type="text" name="budgetEpicerie" class="w-full px-3 py-3 border rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-red-800 bg-white/90">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-1">Protéine par semaine</label>
                            <input type="text" name="proteineParSemaine" class="w-full px-3 py-3 border rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-red-800 bg-white/90">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-1">Congélateur autre que celui du frigo</label>
                            <select name="congelateurAutre" class="w-full px-3 py-3 border rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-red-800 bg-white/90">
                                <option value="">Sélectionner...</option>
                                <option value="oui">Oui</option>
                                <option value="non">Non</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-1">Place pour un congélateur</label>
                            <select name="placeCongel" class="w-full px-3 py-3 border rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-red-800 bg-white/90">
                                <option value="">Sélectionner...</option>
                                <option value="oui">Oui</option>
                                <option value="non">Non</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-1">Capacité du congélateur</label>
                            <select name="grandeurCongel" class="w-full px-3 py-3 border rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-red-800 bg-white/90">
                                <option value="">Sélectionner...</option>
                                <option value="vide">Vide</option>
                                <option value="moitie">Moitié</option>
                                <option value="plein">Plein</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Notes Section -->
                <div class="mb-4">
                    <h2 class="text-lg font-bold mb-4 text-gray-900 border-b border-red-800/20 pb-2">Notes</h2>
                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-1">Note Importante</label>
                        <textarea name="noteImportante" rows="4" class="w-full px-3 py-3 border rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-red-800 bg-white/90"></textarea>
                    </div>
                    <div class="mt-4">
                        <label class="block text-gray-700 text-sm font-medium mb-1">Fournisseur</label>
                        <textarea name="fournisseur" rows="4" class="w-full px-3 py-3 border rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-red-800 bg-white/90"></textarea>
                    </div>
                </div>

                <!-- Submit Button -->
                <button type="submit" id="submitBtn" class="w-full bg-red-800 text-white py-3 px-4 rounded-lg text-lg font-medium hover:bg-red-900 focus:outline-none focus:ring-2 focus:ring-red-700">
                    Envoyer
                </button>
            </form>
<!-- Preview Modal -->
<div id="previewModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-full max-w-4xl shadow-lg rounded-md glass-effect">
        <div class="flex flex-col h-full">
            <!-- Modal Header -->
            <div class="flex justify-between items-center pb-3 border-b border-red-800/20">
                <p class="text-2xl font-bold text-gray-900">Aperçu du message</p>
                <button id="closeModal" class="text-gray-400 hover:text-red-800">
                    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            <!-- Discord-like Preview -->
            <div class="mt-4 bg-[#36393f] rounded-lg p-4 text-white overflow-y-auto max-h-[60vh] min-h-[200px] shadow-xl">
                <div id="previewContent" class="space-y-4">
                    <!-- Preview content will be inserted here -->
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="flex justify-end gap-4 mt-4 relative z-10">
                <button id="modifyBtn" class="px-4 py-2 bg-gray-100 text-gray-800 rounded-lg hover:bg-gray-200 shadow-sm">
                    Modifier
                </button>
                <button id="confirmSendBtn" class="px-4 py-2 bg-red-800 text-white rounded-lg hover:bg-red-900 shadow-sm">
                    Confirmer l'envoi
                </button>
            </div>
        </div>
    </div>
</div>

    <script>
const DISCORD_WEBHOOK_URL = 'https://discord.com/api/webhooks/1335042984584151040/QeZ3FhVq7PNZsEQKzQihOLKbaGU1UuK_eMTZgdmO_P9jF77H01ssthp6vGX6cHfNj7FX';

function checkAuth() {
    const currentUser = JSON.parse(localStorage.getItem('currentUser'));
    if (!currentUser) {
        window.location.href = 'index.html';
        return;
    }

    document.getElementById('userName').textContent = currentUser.name;
    document.getElementById('userRole').textContent = 
        currentUser.role === 'supervisor' ? 'Superviseur' : 'Portier';
}

function logout() {
    localStorage.removeItem('currentUser');
    window.location.href = 'index.html';
}

function formatPhoneNumber(phoneNumber) {
    // Remove all non-numeric characters
    const cleaned = phoneNumber.replace(/\D/g, '');
    
    // Check if we have a 10-digit number
    if(cleaned.length === 10) {
        return cleaned.replace(/(\d{3})(\d{3})(\d{4})/, '$1-$2-$3');
    }
    
    // If not 10 digits, return original input
    return phoneNumber;
}

function createMessageContent(form, currentUser) {
    const orderNumber = form.get('orderNumber') || 'Non spécifié';
    const region = form.get('region') || 'Non spécifiée';
    return {
        embeds: [{
            title: `📋 Nouvelle Fiche Client - ${orderNumber}`,
            color: 3447003,
            fields: [
		{
                     name: '🔍 Information de suivi',
                     value: [
                        `**Numéro de commande:** ${orderNumber}`,
                        `**Région:** ${region}`
                   ].join('\n'),
                   inline: false
                },
                {
                    name: '📅 Information de la visite',
                    value: [
                        `**Date de réception:** ${form.get('dateReception')}`,
                        `**Date de présentation:** ${form.get('datePresentation')}`,
                        `**Heure de présentation:** ${form.get('heurePresentation')}`,
                        `**Distributeur:** ${form.get('distributeur')}`,
                        `**Superviseur:** ${form.get('superviseur')}`
                    ].join('\n'),
                    inline: false
                },
                {
                    name: '👤 Information du client',
                    value: [
                        `**Nom (1):** ${form.get('nomComplet1')}`,
                        `**Nom (2):** ${form.get('nomComplet2')}`,
                        `**Adresse:** ${form.get('adresse')}`,
                        `**Courriel:** ${form.get('courriel')}`,
                        `**Ville:** ${form.get('ville')}`,
                        `**Code postal:** ${form.get('codePostal')}`,
                        `**Cellulaire (1):** ${formatPhoneNumber(form.get('cellulaire1') || '')}`,
                        `**Cellulaire (2):** ${formatPhoneNumber(form.get('cellulaire2') || '')}`
                    ].join('\n'),
                    inline: false
                },
                {
                    name: 'ℹ️ Information additionnelle',
                    value: [
                        `**Emploi:** ${form.get('emploi')}`,
                        `**Statut:** ${form.get('statut')}`,
                        `**Adultes:** ${form.get('nombreAdultes')}`,
                        `**Enfants:** ${form.get('nombreEnfants')}`
                    ].join('\n'),
                    inline: false
                },
                {
                    name: '🍖 Information sur l\'alimentation',
                    value: [
                        `**Budget épicerie:** ${form.get('budgetEpicerie')}`,
                        `**Protéine/semaine:** ${form.get('proteineParSemaine')}`,
                        `**Autre congélateur:** ${form.get('congelateurAutre')}`,
                        `**Place congélateur:** ${form.get('placeCongel')}`,
                        `**État congélateur:** ${form.get('grandeurCongel')}`
                    ].join('\n'),
                    inline: false
                },
                {
                    name: '📝 Notes',
                    value: [
                        `**Note importante:** ${form.get('noteImportante') || 'Aucune'}`,
                        `**Fournisseur:** ${form.get('fournisseur') || 'Aucun'}`
                    ].join('\n'),
                    inline: false
                }
            ],
            footer: {
                text: `Soumis par: ${currentUser.name} (${currentUser.role === 'supervisor' ? 'Superviseur' : 'Portier'}) | ${orderNumber}`
            }
        }]
    };
}
function generateOrderNumber() {
    const date = new Date();
    const year = date.getFullYear().toString().substr(-2);
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    const day = date.getDate().toString().padStart(2, '0');
    
    // Add hours and minutes to make it unique across simultaneous submissions
    const hours = date.getHours().toString().padStart(2, '0');
    const minutes = date.getMinutes().toString().padStart(2, '0');
    
    // Generate a random 3-digit number (000-999)
    const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
    
    // Combine everything into the order number
    // Format: AP + YY + MM + DD + HHmm + RRR
    // Example: AP + 25 + 02 + 14 + 1423 + 847
    return `AP${year}${month}${day}${hours}${minutes}${random}`;
}

// Update the HTML pattern to match the new format
document.addEventListener('DOMContentLoaded', function() {
    const orderNumberInput = document.querySelector('input[name="orderNumber"]');
    if (orderNumberInput) {
        orderNumberInput.pattern = "AP\\d{13}"; // Updated to match 13 digits after AP
        orderNumberInput.title = "Format: AP + YYMMDDHHmmRRR";
    }
});
async function sendToDiscord(messageContent, form) {
    const submitBtn = document.getElementById('submitBtn');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Envoi en cours...';

    try {
        const response = await fetch(DISCORD_WEBHOOK_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(messageContent)
        });

        if (response.ok) {
            alert('Information envoyée avec succès!');
            form.reset();
            return true;
        } else {
            throw new Error('Erreur lors de l\'envoi');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Erreur lors de l\'envoi. Veuillez réessayer.');
        return false;
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Envoyer';
    }
}

function showPreview(messageContent) {
    console.log('Showing preview:', messageContent); // Debug log
    const modal = document.getElementById('previewModal');
    const previewContent = document.getElementById('previewContent');
    
    // Clear previous content
    previewContent.innerHTML = '';
    
    // Create Discord-like preview
    messageContent.embeds.forEach(embed => {
        const embedDiv = document.createElement('div');
        embedDiv.className = 'border-l-4 border-blue-500 pl-3';
        
        // Add title
        const titleDiv = document.createElement('div');
        titleDiv.className = 'text-xl font-semibold mb-2';
        titleDiv.textContent = embed.title;
        embedDiv.appendChild(titleDiv);
        
        // Add fields
        embed.fields.forEach(field => {
            const fieldDiv = document.createElement('div');
            fieldDiv.className = 'mb-4';
            
            const fieldTitle = document.createElement('div');
            fieldTitle.className = 'font-medium text-gray-300 mb-1';
            fieldTitle.textContent = field.name;
            fieldDiv.appendChild(fieldTitle);
            
            const fieldContent = document.createElement('div');
            fieldContent.className = 'text-sm whitespace-pre-wrap';
            fieldContent.innerHTML = field.value.replace(/\*\*/g, '');
            fieldDiv.appendChild(fieldContent);
            
            embedDiv.appendChild(fieldDiv);
        });
        
        // Add footer
        const footerDiv = document.createElement('div');
        footerDiv.className = 'text-sm text-gray-400 mt-2';
        footerDiv.textContent = embed.footer.text;
        embedDiv.appendChild(footerDiv);
        
        previewContent.appendChild(embedDiv);
    });
    
    modal.classList.remove('hidden');
}

// Initialize event listeners
function initializeEventListeners() {
    console.log('Initializing event listeners'); // Debug log

	 // Add this new code
    document.addEventListener('DOMContentLoaded', function() {
        const orderNumberInput = document.querySelector('input[name="orderNumber"]');
        if (orderNumberInput) {
            orderNumberInput.value = generateOrderNumber();
        }
    });
    // Form submit handler
    document.getElementById('clientForm').addEventListener('submit', function(e) {
        console.log('Form submitted'); // Debug log
        e.preventDefault();
        
        // Generate order number at submission
        const orderNumberInput = document.querySelector('input[name="orderNumber"]');
        orderNumberInput.value = generateOrderNumber();
        
        const form = new FormData(this);
        const currentUser = JSON.parse(localStorage.getItem('currentUser'));
        const messageContent = createMessageContent(form, currentUser);
        showPreview(messageContent);
    });

    // Modal close button handler
    document.getElementById('closeModal').addEventListener('click', function() {
        document.getElementById('previewModal').classList.add('hidden');
    });

    // Modify button handler
    document.getElementById('modifyBtn').addEventListener('click', function() {
        document.getElementById('previewModal').classList.add('hidden');
    });


    // Confirm send button handler
    document.getElementById('confirmSendBtn').addEventListener('click', async function() {
        const form = document.getElementById('clientForm');
        const formData = new FormData(form);
        const currentUser = JSON.parse(localStorage.getItem('currentUser'));
        const messageContent = createMessageContent(formData, currentUser);
    
    document.getElementById('previewModal').classList.add('hidden');
    const success = await sendToDiscord(messageContent, form);
    
    if (success) {
        form.reset();
        const orderNumberInput = document.querySelector('input[name="orderNumber"]');
        if (orderNumberInput) {
            orderNumberInput.value = generateOrderNumber();
        }
    }
});
}
// Initialize when the page loads
window.addEventListener('load', () => {
    checkAuth();
    initializeEventListeners();
});
    </script>
</body>
</html>
